<script>
  // Set today's date as the minimum for the adminDate picker
  window.addEventListener("load", () => {
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("adminDate").min = today;
    deletePastBookings(); // run cleanup
  });

  function checkPIN() {
    const input = document.getElementById('pinInput').value;
    if (input === '9110') {
      localStorage.setItem('adminUnlocked', 'true');
      document.getElementById('pinGate').classList.add('hidden');
      document.getElementById('adminPanel').classList.remove('hidden');
    } else {
      alert('Incorrect PIN');
    }
  }

  if (localStorage.getItem('adminUnlocked') === 'true') {
    document.getElementById('pinGate').classList.add('hidden');
    document.getElementById('adminPanel').classList.remove('hidden');
  }

  function loadBookings() {
    const date = document.getElementById("adminDate").value;
    const barber = document.getElementById("adminBarber").value;
    const resultsDiv = document.getElementById("adminResults");

    if (!date || !barber) {
      alert("Select both date and barber.");
      return;
    }

    resultsDiv.innerHTML = '<p>Loading...</p>';

    db.collection("bookings")
      .where("date", "==", date)
      .where("barber", "==", barber)
      .orderBy("time")
      .get()
      .then(snapshot => {
        if (snapshot.empty) {
          resultsDiv.innerHTML = '<p>No bookings found.</p>';
          return;
        }

        let html = '';
        snapshot.forEach(doc => {
          const data = doc.data();
          html += `<div class='bg-gray-800 p-4 rounded-lg border border-gray-700'>
            <p><strong>${data.time}</strong></p>
            <p>${data.name}</p>
            <p>${data.phone}</p>
            <p>${data.service}</p>
            <button onclick="deleteBooking('${doc.id}')" class="mt-2 px-3 py-1 bg-red-600 text-white rounded hover:bg-red-500">Delete</button>
          </div>`;
        });

        resultsDiv.innerHTML = html;
      })
      .catch(err => {
        console.error("Error loading bookings:", err);
        resultsDiv.innerHTML = '<p class="text-red-500">Error loading bookings. Check console for details.</p>';
      });
  }

  async function deleteBooking(bookingId) {
    const confirmDelete = confirm("Are you sure you want to delete this booking?");
    if (!confirmDelete) return;

    try {
      await db.collection("bookings").doc(bookingId).delete();
      alert("Booking deleted.");
      loadBookings(); // refresh after deletion
    } catch (error) {
      console.error("Error deleting booking:", error);
      alert("Failed to delete booking.");
    }
  }

  async function deletePastBookings() {
    const today = new Date().toISOString().split("T")[0];

    try {
      const snapshot = await db.collection("bookings")
        .where("date", "<", today)
        .get();

      const batch = db.batch();
      snapshot.forEach(doc => batch.delete(doc.ref));

      await batch.commit();
      console.log("Expired bookings deleted.");
    } catch (err) {
      console.error("Failed to delete past bookings:", err);
    }
  }
</script>
